name: devsecops-lab

networks:
  edge:
    driver: bridge
  platform:
    driver: bridge

volumes:
  postgres_data:
  keycloak_data:
  vault_data:
  prometheus_data:
  grafana_data:
  loki_data:
  harbor_db_data:
  harbor_registry_data:
  harbor_redis_data:

services:
  traefik:
    image: traefik:v3.1
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --serversTransport.insecureSkipVerify=true
    ports:
      - "80:80"
      - "443:443"
      - "8088:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik
    networks:
      - edge
      - platform

  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - platform

  keycloak:
    image: quay.io/keycloak/keycloak:25.0.5
    command: ["start-dev"]
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak123
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
      KC_PROXY: edge
    depends_on:
      - postgres
    networks:
      - platform
      - edge
    labels:
      - traefik.enable=true
      - traefik.http.routers.keycloak.rule=Host(`keycloak.localhost`)
      - traefik.http.routers.keycloak.entrypoints=web
      - traefik.http.services.keycloak.loadbalancer.server.port=8080

  vault:
    image: hashicorp/vault:1.17
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    command: ["vault", "server", "-dev", "-dev-root-token-id=root"]
    volumes:
      - vault_data:/vault/file
    networks:
      - platform
      - edge
    labels:
      - traefik.enable=true
      - traefik.http.routers.vault.rule=Host(`vault.localhost`)
      - traefik.http.routers.vault.entrypoints=web
      - traefik.http.services.vault.loadbalancer.server.port=8200

  trivy:
    image: aquasec/trivy:0.56.2
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./:/workspace
    working_dir: /workspace
    networks:
      - platform

  prometheus:
    image: prom/prometheus:v2.54.1
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    networks:
      - platform
      - edge
    labels:
      - traefik.enable=true
      - traefik.http.routers.prometheus.rule=Host(`prometheus.localhost`)
      - traefik.http.routers.prometheus.entrypoints=web
      - traefik.http.services.prometheus.loadbalancer.server.port=9090

  alertmanager:
    image: prom/alertmanager:v0.27.0
    command:
      - --config.file=/etc/alertmanager/alertmanager.yml
      - --storage.path=/alertmanager
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    networks:
      - platform

  grafana:
    image: grafana/grafana:11.2.2
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - loki
    networks:
      - platform
      - edge
    labels:
      - traefik.enable=true
      - traefik.http.routers.grafana.rule=Host(`grafana.localhost`)
      - traefik.http.routers.grafana.entrypoints=web
      - traefik.http.services.grafana.loadbalancer.server.port=3000

  loki:
    image: grafana/loki:3.1.1
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - ./loki/local-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    networks:
      - platform

  promtail:
    image: grafana/promtail:3.1.1
    command: ["-config.file=/etc/promtail/config.yml"]
    volumes:
      - ./promtail/config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - platform
    depends_on:
      - loki

  step-ca:
    image: smallstep/step-ca:0.27.4
    profiles: ["private-ca"]
    environment:
      DOCKER_STEPCA_INIT_NAME: Local Private CA
      DOCKER_STEPCA_INIT_DNS_NAMES: step-ca,step-ca.localhost
      DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT: "true"
      DOCKER_STEPCA_INIT_PASSWORD: password
    ports:
      - "9000:9000"
    networks:
      - platform

  harbor-db:
    image: goharbor/harbor-db:v2.11.1
    profiles: ["harbor"]
    environment:
      POSTGRES_DB: registry
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Harbor12345
    volumes:
      - harbor_db_data:/var/lib/postgresql/data
    networks:
      - platform

  harbor-redis:
    image: goharbor/redis-photon:v2.11.1
    profiles: ["harbor"]
    volumes:
      - harbor_redis_data:/var/lib/redis
    networks:
      - platform

  harbor-registry:
    image: goharbor/registry-photon:v2.11.1
    profiles: ["harbor"]
    environment:
      REGISTRY_HTTP_ADDR: :5000
    volumes:
      - harbor_registry_data:/storage
    networks:
      - platform
      - edge
    labels:
      - traefik.enable=true
      - traefik.http.routers.harbor-registry.rule=Host(`harbor-registry.localhost`)
      - traefik.http.routers.harbor-registry.entrypoints=web
      - traefik.http.services.harbor-registry.loadbalancer.server.port=5000
